RewriteEngine On

# Security Headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"

# Prevent access to sensitive files
<Files "composer.json">
    Order allow,deny
    Deny from all
</Files>

<FilesMatch "\.env">
    Order allow,deny
    Deny from all
</FilesMatch>

<Files "config.php">
    Order allow,deny
    Deny from all
</Files>

Options -Indexes

# Allow direct access to existing files and directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Admin Routes - Must come first and be very specific
RewriteRule ^admin/?$ admin/dashboard.php [L]
RewriteRule ^admin/login/?$ admin/login.php [L]
RewriteRule ^admin/dashboard/?$ admin/dashboard.php [L]
RewriteRule ^admin/tenants/?$ admin/tenants.php [L]

# Client Routes - Must come second and be very specific  
RewriteRule ^client/?$ client/dashboard.php [L]
RewriteRule ^client/login/?$ client/login.php [L]
RewriteRule ^client/dashboard/?$ client/dashboard.php [L]

# API Routes - Must come third
RewriteRule ^api/auth/?(.*)$ api/auth.php/$1 [QSA,L]
RewriteRule ^api/client-auth/?(.*)$ api/client-auth.php/$1 [QSA,L]
RewriteRule ^api/client-requests/?(.*)$ api/client-requests.php/$1 [QSA,L]
RewriteRule ^api/client-tenants/?(.*)$ api/client-tenants.php/$1 [QSA,L]
RewriteRule ^api/client-analytics/?$ api/client-analytics.php [QSA,L]
RewriteRule ^api/tenants/?(.*)$ api/tenants.php/$1 [QSA,L]
RewriteRule ^api/tmdb/?(.*)$ api/tmdb.php/$1 [QSA,L]
RewriteRule ^api/tenant-requests/?$ api/tenant-requests.php [QSA,L]

# Assets - Allow direct access (already handled by file existence check above)

# Tenant Routes - ONLY for valid tenant slugs (catch-all at the end)
# Only match if it's not admin, client, api, assets, or existing files
RewriteCond %{REQUEST_URI} !^/(admin|client|api|assets|vendor)/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([a-zA-Z0-9\-_]+)/?$ public/tenant_router.php?slug=$1 [QSA,L]

RewriteCond %{REQUEST_URI} !^/(admin|client|api|assets|vendor)/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([a-zA-Z0-9\-_]+)/(.*)$ public/tenant_router.php?slug=$1&path=$2 [QSA,L]